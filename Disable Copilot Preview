$ErrorActionPreference="Stop"

Write-Host "Loading Default User Registry Hive: " -Nonewline
Try{
    REG LOAD "HKEY_USERS\DefaultUser" "C:\Users\Default\NTUSER.DAT"
}
Catch{
    Exit $_.Exception.HResult
}

If (!(Test-Path "Registry::HKEY_USERS\DefaultUser\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Advanced")) {
    Write-Host "Creating Advanced Registry Key: " -Nonewline
    Try{
        New-Item -Path "Registry::HKEY_USERS\DefaultUser\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Advanced" -Force | Out-Null
        Write-Host "OK`r`n"
    }
    Catch{
        Write-Host "Error`r`n"
    }   
}

Write-Host "Hiding Copilot: " -Nonewline
Try{
    Set-ItemProperty -Path "Registry::HKEY_USERS\DefaultUser\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Advanced" -Name "ShowCopilotButton" -Type DWord -Value 0 -Force
    Write-Host "OK`r`n"
}
Catch{
    Write-Host "Error`r`n"
}

Write-Host "Unloading Default User Registry Hive: " -Nonewline
Try{
    [gc]::collect()    
    REG UNLOAD "HKEY_USERS\DefaultUser"
    Write-Host "OK`r`n"
}
Catch{
    Write-Host "Error`r`n"
}
